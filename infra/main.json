{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.37.4.10188",
      "templateHash": "13548335637946101862"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "eastus",
      "metadata": {
        "description": "Location for all resources"
      }
    },
    "environmentName": {
      "type": "string",
      "defaultValue": "burnout",
      "metadata": {
        "description": "Environment name used as prefix for resource names"
      }
    },
    "openAiDeployment": {
      "type": "string",
      "defaultValue": "gpt-4o",
      "metadata": {
        "description": "Azure OpenAI model deployment name"
      }
    },
    "openAiModelName": {
      "type": "string",
      "defaultValue": "gpt-4o",
      "metadata": {
        "description": "Azure OpenAI model name"
      }
    },
    "openAiModelVersion": {
      "type": "string",
      "defaultValue": "2024-08-06",
      "metadata": {
        "description": "Azure OpenAI model version"
      }
    },
    "containerImageName": {
      "type": "string",
      "defaultValue": "burnout-backend:latest",
      "metadata": {
        "description": "Container image name with tag"
      }
    }
  },
  "variables": {
    "identityName": "[format('{0}-identity', parameters('environmentName'))]",
    "openAiName": "[format('{0}-openai', parameters('environmentName'))]",
    "acrName": "[replace(format('{0}acr', parameters('environmentName')), '-', '')]",
    "containerAppsEnvName": "[format('{0}-cae', parameters('environmentName'))]",
    "logAnalyticsName": "[format('{0}-logs', parameters('environmentName'))]",
    "containerAppName": "[format('{0}-backend', parameters('environmentName'))]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "identity-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "identityName": {
            "value": "[variables('identityName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "6928341218949331639"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Location for resources"
              }
            },
            "identityName": {
              "type": "string",
              "metadata": {
                "description": "Name of the managed identity"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2023-01-31",
              "name": "[parameters('identityName')]",
              "location": "[parameters('location')]"
            }
          ],
          "outputs": {
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Principal ID of the managed identity"
              },
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('identityName')), '2023-01-31').principalId]"
            },
            "clientId": {
              "type": "string",
              "metadata": {
                "description": "Client ID of the managed identity"
              },
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('identityName')), '2023-01-31').clientId]"
            },
            "resourceId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the managed identity"
              },
              "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('identityName'))]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "openai-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "openAiName": {
            "value": "[variables('openAiName')]"
          },
          "deploymentName": {
            "value": "[parameters('openAiDeployment')]"
          },
          "modelName": {
            "value": "[parameters('openAiModelName')]"
          },
          "modelVersion": {
            "value": "[parameters('openAiModelVersion')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "505188460869216656"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Location for resources"
              }
            },
            "openAiName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Azure OpenAI resource"
              }
            },
            "deploymentName": {
              "type": "string",
              "defaultValue": "gpt-4o",
              "metadata": {
                "description": "Model deployment name"
              }
            },
            "modelName": {
              "type": "string",
              "defaultValue": "gpt-4o",
              "metadata": {
                "description": "Model name to deploy"
              }
            },
            "modelVersion": {
              "type": "string",
              "defaultValue": "2024-08-06",
              "metadata": {
                "description": "Model version"
              }
            },
            "capacityK": {
              "type": "int",
              "defaultValue": 10,
              "metadata": {
                "description": "Capacity in thousands of tokens per minute"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.CognitiveServices/accounts",
              "apiVersion": "2024-10-01",
              "name": "[parameters('openAiName')]",
              "location": "[parameters('location')]",
              "kind": "OpenAI",
              "sku": {
                "name": "S0"
              },
              "properties": {
                "customSubDomainName": "[parameters('openAiName')]",
                "publicNetworkAccess": "Enabled"
              }
            },
            {
              "type": "Microsoft.CognitiveServices/accounts/deployments",
              "apiVersion": "2024-10-01",
              "name": "[format('{0}/{1}', parameters('openAiName'), parameters('deploymentName'))]",
              "sku": {
                "name": "Standard",
                "capacity": "[parameters('capacityK')]"
              },
              "properties": {
                "model": {
                  "format": "OpenAI",
                  "name": "[parameters('modelName')]",
                  "version": "[parameters('modelVersion')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', parameters('openAiName'))]"
              ]
            }
          ],
          "outputs": {
            "endpoint": {
              "type": "string",
              "metadata": {
                "description": "Azure OpenAI endpoint URL"
              },
              "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('openAiName')), '2024-10-01').endpoint]"
            },
            "resourceId": {
              "type": "string",
              "metadata": {
                "description": "Azure OpenAI resource ID"
              },
              "value": "[resourceId('Microsoft.CognitiveServices/accounts', parameters('openAiName'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Azure OpenAI resource name"
              },
              "value": "[parameters('openAiName')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "openai-rbac-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "principalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'identity-deployment'), '2022-09-01').outputs.principalId.value]"
          },
          "openAiResourceId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'openai-deployment'), '2022-09-01').outputs.resourceId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "13482690550970954002"
            }
          },
          "parameters": {
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Principal ID to assign the role to"
              }
            },
            "openAiResourceId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the Azure OpenAI resource"
              }
            }
          },
          "variables": {
            "cognitiveServicesOpenAiUserRoleId": "5e0bd9bd-7b93-4f28-af87-19fc36ad61bd"
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', last(split(parameters('openAiResourceId'), '/')))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', last(split(parameters('openAiResourceId'), '/'))), parameters('principalId'), variables('cognitiveServicesOpenAiUserRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('cognitiveServicesOpenAiUserRoleId'))]",
                "principalId": "[parameters('principalId')]",
                "principalType": "ServicePrincipal"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'identity-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'openai-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "acr-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "acrName": {
            "value": "[variables('acrName')]"
          },
          "principalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'identity-deployment'), '2022-09-01').outputs.principalId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "4237484032317437082"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Location for resources"
              }
            },
            "acrName": {
              "type": "string",
              "metadata": {
                "description": "Name of the container registry (alphanumeric only)"
              }
            },
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Principal ID to assign AcrPull role to"
              }
            }
          },
          "variables": {
            "acrPullRoleId": "7f951dda-4ed3-4680-a7ca-43fe172d538d"
          },
          "resources": [
            {
              "type": "Microsoft.ContainerRegistry/registries",
              "apiVersion": "2023-07-01",
              "name": "[parameters('acrName')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Basic"
              },
              "properties": {
                "adminUserEnabled": true
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.ContainerRegistry/registries/{0}', parameters('acrName'))]",
              "name": "[guid(resourceId('Microsoft.ContainerRegistry/registries', parameters('acrName')), parameters('principalId'), variables('acrPullRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('acrPullRoleId'))]",
                "principalId": "[parameters('principalId')]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.ContainerRegistry/registries', parameters('acrName'))]"
              ]
            }
          ],
          "outputs": {
            "loginServer": {
              "type": "string",
              "metadata": {
                "description": "ACR login server"
              },
              "value": "[reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('acrName')), '2023-07-01').loginServer]"
            },
            "resourceId": {
              "type": "string",
              "metadata": {
                "description": "ACR resource ID"
              },
              "value": "[resourceId('Microsoft.ContainerRegistry/registries', parameters('acrName'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "ACR name"
              },
              "value": "[parameters('acrName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'identity-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "container-apps-env-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environmentName": {
            "value": "[variables('containerAppsEnvName')]"
          },
          "logAnalyticsName": {
            "value": "[variables('logAnalyticsName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "4014437096309261033"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Location for resources"
              }
            },
            "environmentName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Container Apps environment"
              }
            },
            "logAnalyticsName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Log Analytics workspace"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2023-09-01",
              "name": "[parameters('logAnalyticsName')]",
              "location": "[parameters('location')]",
              "properties": {
                "sku": {
                  "name": "PerGB2018"
                },
                "retentionInDays": 30
              }
            },
            {
              "type": "Microsoft.App/managedEnvironments",
              "apiVersion": "2024-03-01",
              "name": "[parameters('environmentName')]",
              "location": "[parameters('location')]",
              "properties": {
                "appLogsConfiguration": {
                  "destination": "log-analytics",
                  "logAnalyticsConfiguration": {
                    "customerId": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsName')), '2023-09-01').customerId]",
                    "sharedKey": "[listKeys(resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsName')), '2023-09-01').primarySharedKey]"
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsName'))]"
              ]
            }
          ],
          "outputs": {
            "environmentId": {
              "type": "string",
              "metadata": {
                "description": "Container Apps environment ID"
              },
              "value": "[resourceId('Microsoft.App/managedEnvironments', parameters('environmentName'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Container Apps environment name"
              },
              "value": "[parameters('environmentName')]"
            },
            "defaultDomain": {
              "type": "string",
              "metadata": {
                "description": "Default domain for the environment"
              },
              "value": "[reference(resourceId('Microsoft.App/managedEnvironments', parameters('environmentName')), '2024-03-01').defaultDomain]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "container-app-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "containerAppName": {
            "value": "[variables('containerAppName')]"
          },
          "environmentId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'container-apps-env-deployment'), '2022-09-01').outputs.environmentId.value]"
          },
          "acrLoginServer": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'acr-deployment'), '2022-09-01').outputs.loginServer.value]"
          },
          "imageName": {
            "value": "[parameters('containerImageName')]"
          },
          "identityResourceId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'identity-deployment'), '2022-09-01').outputs.resourceId.value]"
          },
          "identityClientId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'identity-deployment'), '2022-09-01').outputs.clientId.value]"
          },
          "openAiEndpoint": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'openai-deployment'), '2022-09-01').outputs.endpoint.value]"
          },
          "openAiDeployment": {
            "value": "[parameters('openAiDeployment')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "11419519440093944269"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Location for resources"
              }
            },
            "containerAppName": {
              "type": "string",
              "metadata": {
                "description": "Name of the container app"
              }
            },
            "environmentId": {
              "type": "string",
              "metadata": {
                "description": "Container Apps environment ID"
              }
            },
            "acrLoginServer": {
              "type": "string",
              "metadata": {
                "description": "ACR login server"
              }
            },
            "imageName": {
              "type": "string",
              "defaultValue": "burnout-backend:latest",
              "metadata": {
                "description": "Container image name with tag"
              }
            },
            "identityResourceId": {
              "type": "string",
              "metadata": {
                "description": "User-assigned managed identity resource ID"
              }
            },
            "identityClientId": {
              "type": "string",
              "metadata": {
                "description": "User-assigned managed identity client ID"
              }
            },
            "openAiEndpoint": {
              "type": "string",
              "metadata": {
                "description": "Azure OpenAI endpoint URL"
              }
            },
            "openAiDeployment": {
              "type": "string",
              "defaultValue": "gpt-4o",
              "metadata": {
                "description": "Azure OpenAI deployment name"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.App/containerApps",
              "apiVersion": "2024-03-01",
              "name": "[parameters('containerAppName')]",
              "location": "[parameters('location')]",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('identityResourceId'))]": {}
                }
              },
              "properties": {
                "managedEnvironmentId": "[parameters('environmentId')]",
                "configuration": {
                  "ingress": {
                    "external": true,
                    "targetPort": 8080,
                    "transport": "auto",
                    "allowInsecure": false
                  },
                  "registries": [
                    {
                      "server": "[parameters('acrLoginServer')]",
                      "identity": "[parameters('identityResourceId')]"
                    }
                  ]
                },
                "template": {
                  "containers": [
                    {
                      "name": "burnout-backend",
                      "image": "[format('{0}/{1}', parameters('acrLoginServer'), parameters('imageName'))]",
                      "resources": {
                        "cpu": "[json('0.5')]",
                        "memory": "1Gi"
                      },
                      "env": [
                        {
                          "name": "AZURE_OPENAI_ENDPOINT",
                          "value": "[parameters('openAiEndpoint')]"
                        },
                        {
                          "name": "AZURE_OPENAI_DEPLOYMENT",
                          "value": "[parameters('openAiDeployment')]"
                        },
                        {
                          "name": "AZURE_IDENTITY_CLIENT_ID",
                          "value": "[parameters('identityClientId')]"
                        }
                      ],
                      "probes": [
                        {
                          "type": "Liveness",
                          "httpGet": {
                            "path": "/actuator/health",
                            "port": 8080
                          },
                          "initialDelaySeconds": 30,
                          "periodSeconds": 10
                        },
                        {
                          "type": "Readiness",
                          "httpGet": {
                            "path": "/actuator/health",
                            "port": 8080
                          },
                          "initialDelaySeconds": 10,
                          "periodSeconds": 5
                        }
                      ]
                    }
                  ],
                  "scale": {
                    "minReplicas": 0,
                    "maxReplicas": 3,
                    "rules": [
                      {
                        "name": "http-scaling",
                        "http": {
                          "metadata": {
                            "concurrentRequests": "10"
                          }
                        }
                      }
                    ]
                  }
                }
              }
            }
          ],
          "outputs": {
            "fqdn": {
              "type": "string",
              "metadata": {
                "description": "Container App FQDN"
              },
              "value": "[reference(resourceId('Microsoft.App/containerApps', parameters('containerAppName')), '2024-03-01').configuration.ingress.fqdn]"
            },
            "url": {
              "type": "string",
              "metadata": {
                "description": "Container App URL"
              },
              "value": "[format('https://{0}', reference(resourceId('Microsoft.App/containerApps', parameters('containerAppName')), '2024-03-01').configuration.ingress.fqdn)]"
            },
            "resourceId": {
              "type": "string",
              "metadata": {
                "description": "Container App resource ID"
              },
              "value": "[resourceId('Microsoft.App/containerApps', parameters('containerAppName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'acr-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'container-apps-env-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'identity-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'openai-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'openai-rbac-deployment')]"
      ]
    }
  ],
  "outputs": {
    "SERVICE_BACKEND_URI": {
      "type": "string",
      "metadata": {
        "description": "Container App URL - used by azd for SERVICE_BACKEND_URI"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'container-app-deployment'), '2022-09-01').outputs.url.value]"
    },
    "AZURE_CONTAINER_REGISTRY_ENDPOINT": {
      "type": "string",
      "metadata": {
        "description": "ACR endpoint - required by azd for container deployments"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'acr-deployment'), '2022-09-01').outputs.loginServer.value]"
    },
    "AZURE_CONTAINER_REGISTRY_NAME": {
      "type": "string",
      "metadata": {
        "description": "ACR name - required by azd"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'acr-deployment'), '2022-09-01').outputs.name.value]"
    },
    "AZURE_CONTAINER_APPS_ENVIRONMENT_NAME": {
      "type": "string",
      "metadata": {
        "description": "Container Apps Environment name"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'container-apps-env-deployment'), '2022-09-01').outputs.name.value]"
    },
    "SERVICE_BACKEND_NAME": {
      "type": "string",
      "metadata": {
        "description": "Container App name for backend service"
      },
      "value": "[variables('containerAppName')]"
    },
    "AZURE_CONTAINER_REGISTRY_MANAGED_IDENTITY_ID": {
      "type": "string",
      "metadata": {
        "description": "User-assigned identity resource ID for ACR pull"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'identity-deployment'), '2022-09-01').outputs.resourceId.value]"
    },
    "AZURE_OPENAI_ENDPOINT": {
      "type": "string",
      "metadata": {
        "description": "Azure OpenAI endpoint"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'openai-deployment'), '2022-09-01').outputs.endpoint.value]"
    },
    "identityClientId": {
      "type": "string",
      "metadata": {
        "description": "Managed identity client ID"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'identity-deployment'), '2022-09-01').outputs.clientId.value]"
    }
  }
}